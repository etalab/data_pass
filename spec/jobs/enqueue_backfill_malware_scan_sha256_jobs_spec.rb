RSpec.describe EnqueueBackfillMalwareScanSha256Jobs do
  subject { described_class.new.perform }

  describe 'when there are MalwareScans without sha256' do
    let!(:scan_without_sha256) do
      scan = create(:malware_scan)
      scan.update_column(:sha256, nil)
      scan
    end
    let!(:scan_with_sha256) { create(:malware_scan, sha256: 'existing_hash') }

    it 'enqueues BackfillMalwareScanSha256Job for each MalwareScan without sha256' do
      expect(BackfillMalwareScanSha256Job).to receive(:perform_later).with(scan_without_sha256.id)
      expect(BackfillMalwareScanSha256Job).not_to receive(:perform_later).with(scan_with_sha256.id)

      subject
    end
  end

  describe 'when there are no MalwareScans without sha256' do
    let!(:scan_with_sha256) { create(:malware_scan, sha256: 'existing_hash') }

    it 'does not enqueue any jobs' do
      expect(BackfillMalwareScanSha256Job).not_to receive(:perform_later)

      subject
    end
  end
end
