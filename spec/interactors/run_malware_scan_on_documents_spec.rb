RSpec.describe RunMalwareScanOnDocuments do
  subject { described_class.call(authorization_request:) }

  describe '#call' do
    context 'with API Entreprise authorization request' do
      let(:authorization_request) { create(:authorization_request, :api_entreprise, :draft) }

      before do
        authorization_request.maquette_projet.attach(io: File.open('spec/fixtures/dummy.pdf'), filename: 'dummy.pdf')
        authorization_request.cadre_juridique_document.attach(io: File.open('spec/fixtures/another_dummy.pdf'), filename: 'another_dummy.pdf')
      end

      it 'runs a MalwareScanJob for each attachments file' do
        attachments = ActiveStorage::Attachment.where(record: authorization_request)

        attachments.each do |attachment|
          expect(MalwareScanJob).to receive(:perform_later).with(attachment.id)
        end

        subject
      end
    end

    context 'with API Impot Particulier authorization request with safety certification' do
      let(:authorization_request) { create(:authorization_request, :api_impot_particulier_production, :draft) }

      before do
        authorization_request.safety_certification_document.attach(io: File.open('spec/fixtures/dummy.pdf'), filename: 'dummy.pdf')
      end

      it 'runs a MalwareScanJob for the safety certification document' do
        expect(MalwareScanJob).to receive(:perform_later).with(authorization_request.safety_certification_document.attachment.id)

        subject
      end
    end
  end
end
