<div
  class="<%= select_group_classes %>"
  data-controller="dsfr-multi-select"
  data-dsfr-multi-select-name-value="<%= name %>"
  data-dsfr-multi-select-placeholder-value="<%= placeholder %>"
  data-dsfr-multi-select-all-label-value="<%= all_label %>"
  id="<%= component_id %>">

  <%# Label %>
  <% if label %>
    <label class="fr-label" id="<%= label_id %>">
      <%= label %>
      <% if hint %>
        <span class="fr-hint-text"><%= hint %></span>
      <% end %>
    </label>
  <% end %>

  <div class="dsfrx-multiselect" data-dsfr-multi-select-target="container">
    <%# Control input (combobox trigger) %>
    <div
      class="<%= control_classes %>"
      role="combobox"
      tabindex="<%= disabled ? -1 : 0 %>"
      aria-haspopup="listbox"
      aria-expanded="false"
      aria-controls="<%= listbox_id %>"
      aria-labelledby="<%= label_id if label %>"
      aria-describedby="<%= messages_id if message %>"
      <% if disabled %>aria-disabled="true"<% end %>
      data-dsfr-multi-select-target="trigger"
      data-action="click->dsfr-multi-select#toggle keydown->dsfr-multi-select#handleTriggerKeydown">
      <span class="dsfrx-multiselect__label <%= 'dsfrx-multiselect--placeholder' if none_selected? %>" data-dsfr-multi-select-target="label">
        <%= display_label %>
      </span>
    </div>

    <%# Dropdown %>
    <div
      class="dsfrx-dropdown dsfrx-multiselect__wrapper fr-hidden"
      data-dsfr-multi-select-target="dropdown"
      aria-hidden="true">

      <%# Toolbar (Select All + Search) %>
      <% if show_select_all || show_search %>
        <div
          class="dsfrx-multiselect__toolbar"
          data-dsfr-multi-select-target="toolbar"
          data-action="keydown->dsfr-multi-select#handleToolbarKeydown">
          <% if show_select_all %>
            <button
              type="button"
              class="fr-btn fr-btn--sm fr-btn--tertiary fr-btn--select-all"
              data-dsfr-multi-select-target="selectAllButton"
              data-action="click->dsfr-multi-select#toggleSelectAll">
              <span data-dsfr-multi-select-target="selectAllLabel">
                <%= none_selected? ? 'Tout sélectionner' : 'Tout désélectionner' %>
              </span>
            </button>
          <% end %>

          <% if show_search %>
            <label for="<%= searchbox_id %>" class="fr-sr-only">Rechercher dans la liste</label>
            <div class="fr-input-wrap fr-icon-search-line">
              <input
                type="search"
                class="fr-input"
                id="<%= searchbox_id %>"
                placeholder="<%= search_placeholder %>"
                autocomplete="off"
                data-dsfr-multi-select-target="searchInput"
                data-action="input->dsfr-multi-select#handleSearch">
            </div>
          <% end %>

          <%# Screen reader announcement for search results %>
          <div role="status" aria-live="polite" class="fr-sr-only" data-dsfr-multi-select-target="srAnnouncement"></div>
        </div>
      <% end %>

      <%# Options list %>
      <ul
        class="dsfrx-multiselect__list"
        role="listbox"
        aria-multiselectable="true"
        id="<%= listbox_id %>"
        tabindex="-1"
        data-dsfr-multi-select-target="listbox">
        <% option_index = 0 %>
        <% normalized_options.each_with_index do |item, group_index| %>
          <% if item[:group] %>
            <%# Option Group %>
            <li role="group" aria-labelledby="<%= component_id %>-group-<%= group_index %>" class="dsfrx-multiselect__group">
              <span id="<%= component_id %>-group-<%= group_index %>" role="presentation" class="dsfrx-multiselect__group-label">
                <%= item[:label] %>
              </span>
              <ul role="none" class="dsfrx-multiselect__group-options">
                <% item[:options].each do |option| %>
                  <%= render_option(option, option_index) %>
                  <% option_index += 1 %>
                <% end %>
              </ul>
            </li>
          <% else %>
            <%# Regular Option %>
            <%= render_option(item, option_index) %>
            <% option_index += 1 %>
          <% end %>
        <% end %>
      </ul>

      <%# Empty state %>
      <div
        class="dsfrx-multiselect__list dsfrx-multiselect__list--empty fr-hidden"
        role="status"
        aria-live="polite"
        data-dsfr-multi-select-target="emptyState">
        <p>Aucun résultat</p>
      </div>
    </div>

    <%# Hidden inputs %>
    <div class="dsfrx-multiselect__hidden-inputs" data-dsfr-multi-select-target="hiddenInputs">
      <% selected.each do |value| %>
        <input type="hidden" name="<%= name %>" value="<%= value %>">
      <% end %>
    </div>
  </div>

  <%# Messages %>
  <% if message %>
    <div id="<%= messages_id %>" class="fr-messages-group" aria-live="polite">
      <p class="fr-message fr-message--<%= message_severity %>">
        <%= message %>
      </p>
    </div>
  <% end %>
</div>

