RSpec.describe RunMalwareScanOnAttachments do
  subject { described_class.call(authorization_request:) }

  let(:authorization_request) { create(:authorization_request, :api_entreprise, :draft) }

  before do
    authorization_request.maquette_projet.attach(io: File.open('spec/fixtures/dummy.pdf'), filename: 'dummy.pdf')
    authorization_request.cadre_juridique_document.attach(io: File.open('spec/fixtures/another_dummy.pdf'), filename: 'another_dummy.pdf')
  end

  describe '#call' do
    let(:documents_to_scan) do
      [
        authorization_request.maquette_projet,
        authorization_request.cadre_juridique_document
      ]
    end

    it 'runs a MalwareScanJob for each attachments file' do
      attachments = ActiveStorage::Attachment.where(record: authorization_request)
      raise 'Attachments should not be blank' if attachments.blank?

      attachments.each do |attachment|
        expect(MalwareScanJob).to receive(:perform_later).with(attachment.id)
      end

      subject
    end
  end
end
