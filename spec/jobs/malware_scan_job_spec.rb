RSpec.describe MalwareScanJob do
  subject { described_class.new(attachment_id).perform_now }

  let(:uuid) { SecureRandom.uuid }
  let(:api_client_double) { instance_double(JeCliqueOuPasAPIClient) }
  let(:attachment) { create(:active_storage_attachment) }
  let(:attachment_id) { attachment.id }
  let(:file_content) { 'dummy_content' }

  before do
    allow(JeCliqueOuPasAPIClient).to receive(:new).and_return(api_client_double)

    allow(api_client_double).to receive(:analyze).and_return({ uuid:, errors: nil })
  end

  it 'launches the malware scan' do
    expect(api_client_double).to receive(:analyze).with(file_content)

    subject
  end

  it 'creates a MalwareScan with right params' do
    expect { subject }.to change(MalwareScan, :count).by(1)
    expect(MalwareScan.last.uuid).to eq(uuid)
    expect(MalwareScan.last.attachment).to eq(attachment)
  end

  it 'calls MalwareScanRetrieveStateJob with the analysis uuid' do
    expect(MalwareScanRetrieveStateJob).to receive(:perform_later).with(uuid)

    subject
  end
end
