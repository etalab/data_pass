RSpec.describe RunMalwareScanOnAttachments do
  subject { described_class.call(authorization_request:) }

  let(:authorization_request) { create(:authorization_request, :api_entreprise, :draft) }

  describe '#call' do
    let(:documents_to_scan) do
      [
        authorization_request.maquette_projet,
        authorization_request.cadre_juridique_document
      ]
    end

    it 'runs a MalwareScanJob for each attachments file' do
      documents_to_scan.each do |document|
        attachements = document.respond_to?(:attachments) ? document.attachments : Array(document.attachment)
        next if attachements.blank?

        attachments.each do |attachment|
          expect(MalwareScanJob).to receive(:perform_later).with(attachment.id)
        end
      end

      subject
    end
  end
end
