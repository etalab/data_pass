<% set_title! t('page_titles.authorization_request_summary', definition_name: @authorization_request.definition.name) %>

<%= authorization_request_form(@authorization_request) do |f| %>
  <div id="<%= dom_id(@authorization_request, :summary) %>" class="fr-mt-4w">
    <% if @bulk_update.present? %>
      <%= render partial: 'authorization_requests/bulk_update_modal' %>
    <% end %>

    <% if !displayed_on_a_public_page? %>
      <%= render Applicant::DemandeAlertsComponent.new(
        authorization_request: @authorization_request,
        current_user: current_user,
        authorization: @authorization
      ) %>
    <% end %>

    <%= render partial: 'demandes_habilitations/organization_and_applicant', locals: { demande: @authorization_request } %>

    <% @authorization_request.blocks.each do |block| %>
      <% next if block[:name].to_s == 'contacts' && displayed_on_a_public_page? %>

      <%= render_custom_block_or_default(@authorization_request, block[:name], f:, editable: @authorization_request.filling? && block[:editable]) %>
    <% end %>

    <% if @authorization_request.draft? && !displayed_on_a_public_page? %>
      <%= render partial: 'authorization_request_forms/shared/tos_checkboxes', locals: { f: f } %>
    <% else %>
      <%= render_accepted_tos_checkboxes(@authorization_request, f: f, editable: false) %>
    <% end %>
  </div>

  <% if policy(@authorization_request).cancel_reopening? %>
    <% content_for :sticky_bar do %>
      <div class="fr-container fr-grid-row">
        <div class="fr-col-12">
          <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--icon-left fr-btns-group--between">
            <li>
              <%= dsfr_main_modal_button(t('authorization_request_forms.form.cancel_reopening'), new_authorization_request_cancel_reopening_path(@authorization_request), class: %w(fr-btn fr-btn--secondary fr-icon-arrow-left-s-line-double fr-btn--icon-left fr-mb-0)) %>
            </li>
            <li class="fr-ml-auto">
              <%= f.button t('authorization_request_forms.form.submit_reopening'), disabled: !policy(@authorization_request).submit_reopening?, type: :submit, name: :submit, id: :submit_authorization_request, class: %w(fr-btn fr-icon-checkbox-line fr-btn--icon-left fr-mb-0), aria: { describedby: policy(@authorization_request).submit_reopening? ? nil : 'submit-reopening-tooltip' } %>
              <% unless policy(@authorization_request).submit_reopening? %>
                <span class="fr-tooltip fr-placement" id="submit-reopening-tooltip" role="tooltip">
                  <%= t('authorization_request_forms.form.submit_reopening_disabled_tooltip') %>
                </span>
              <% end %>
            </li>
          </ul>
        </div>
      </div>
    <% end %>
  <% elsif policy(@authorization_request).cancel_next_stage? && policy(@authorization_request).submit? %>
    <% content_for :sticky_bar do %>
      <div class="fr-container fr-grid-row">
        <div class="fr-col-12">
          <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--icon-left fr-btns-group--between">
            <li>
              <%= dsfr_main_modal_button(t('authorization_request_forms.form.cancel_next_stage'), cancel_next_authorization_request_stage_path(authorization_request_id: @authorization_request.id), class: %w(fr-btn fr-btn--secondary fr-icon-error-line fr-btn--icon-left fr-mb-0)) %>
            </li>
            <li class="fr-ml-auto">
              <%= f.button t('authorization_request_forms.form.submit'), type: :submit, name: :submit, id: :submit_authorization_request, class: %w(fr-btn fr-icon-checkbox-line fr-btn--icon-left fr-mb-0) %>
            </li>
          </ul>
        </div>
      </div>
    <% end %>
  <% elsif policy(@authorization_request).cancel_next_stage? %>
    <% content_for :sticky_bar do %>
      <div class="fr-container fr-grid-row">
        <div class="fr-col-12">
          <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--icon-left fr-btns-group--between">
            <li>
              <%= dsfr_main_modal_button(t('authorization_request_forms.form.cancel_next_stage'), cancel_next_authorization_request_stage_path(authorization_request_id: @authorization_request.id), class: %w(fr-btn fr-btn--secondary fr-icon-error-line fr-btn--icon-left fr-mb-0)) %>
            </li>
          </ul>
        </div>
      </div>
    <% end %>
  <% elsif policy(@authorization_request).submit? %>
    <% content_for :sticky_bar do %>
      <div class="fr-container fr-grid-row">
        <div class="fr-col-12">
          <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--icon-left fr-btns-group--between">
            <li class="fr-ml-auto">
              <%= f.button t('authorization_request_forms.form.submit'), type: :submit, name: :submit, id: :submit_authorization_request, class: %w(fr-btn fr-icon-checkbox-line fr-btn--icon-left fr-mb-0) %>
            </li>
          </ul>
        </div>
      </div>
    <% end %>
  <% elsif policy(@authorization_request).start_next_stage? %>
    <% content_for :sticky_bar do %>
      <div class="fr-container fr-grid-row">
        <div class="fr-col-12">
          <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--icon-left fr-btns-group--between">
            <li class="fr-ml-auto">
              <%= link_to t('authorization_request_forms.form.start_next_stage'), next_authorization_request_stage_path(@authorization_request), class: %w(fr-btn fr-mb-0) %>
            </li>
          </ul>
        </div>
      </div>
    <% end %>
  <% elsif policy(@authorization_request).ongoing_request? %>
    <% content_for :sticky_bar do %>
      <div class="fr-container fr-grid-row">
        <div class="fr-col-12">
          <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--icon-left fr-btns-group--between">
            <li class="fr-ml-auto">
              <%= link_to t('authorization_request_forms.form.ongoing_request'), authorization_request_path(@authorization_request), class: %w(fr-btn fr-mb-0) %>
            </li>
          </ul>
        </div>
      </div>
    <% end %>
  <% end %>

<% end %>
