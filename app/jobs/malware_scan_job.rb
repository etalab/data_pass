class MalwareScanJob < ApplicationJob
  RETRY_WAIT_TIME = 5.minutes

  retry_on Faraday::ServerError, wait: RETRY_WAIT_TIME, attempts: :infinite
  retry_on Faraday::ConnectionFailed, wait: RETRY_WAIT_TIME, attempts: :infinite

  def perform(attachment_id)
    @attachment = ActiveStorage::Attachment.find_by(id: attachment_id)

    return if @attachment.blank? || @attachment.blob.blank?

    create_and_start_scan
  end

  private

  def create_and_start_scan
    MalwareScan.create!(uuid:, attachment: @attachment)

    MalwareScanRetrieveStateJob.perform_later(uuid)
  end

  def uuid
    scan[:uuid]
  end

  def scan
    @scan ||= JeCliqueOuPasAPIClient.new.analyze(@attachment.blob.download)
  end
end
