class MalwareScanJob < ApplicationJob
  RETRY_WAIT_TIME = 5.minutes

  retry_on Faraday::ServerError, wait: RETRY_WAIT_TIME, attempts: :infinite
  retry_on Faraday::ConnectionFailed, wait: RETRY_WAIT_TIME, attempts: :infinite

  def perform(attachment_id)
    attachment = ActiveStorage::Attachment.find(attachment_id)

    return if attachment&.blob.blank?

    file = attachment.blob.download

    scan = JeCliqueOuPasAPIClient.new.analyze(file)

    uuid = scan[:uuid]

    MalwareScan.create!(uuid:, attachment:)

    MalwareScanRetrieveStateJob.perform_later(uuid)
  end
end
